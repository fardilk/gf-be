import { PrismaClient, Prisma } from '@prisma/client';
import * as argon2 from 'argon2';

const prisma = new PrismaClient();

async function main() {
  // Organization Level seeds
  const orgLevelOrganization = await prisma.organizationLevel.upsert({
    where: { organizationLevelName: 'organization' },
    update: {},
    create: { organizationLevelName: 'organization' },
  });
  const orgLevelIndividual = await prisma.organizationLevel.upsert({
    where: { organizationLevelName: 'individual' },
    update: {},
    create: { organizationLevelName: 'individual' },
  });
  console.log('✅ Seeded organization levels');

  // Gender seeds (simplified - only name)
  await prisma.gender.upsert({ 
    where: { name: 'Male' }, 
    update: {}, 
    create: { name: 'Male' } 
  });
  await prisma.gender.upsert({ 
    where: { name: 'Female' }, 
    update: {}, 
    create: { name: 'Female' } 
  });
  await prisma.gender.upsert({ 
    where: { name: 'Undisclosed' }, 
    update: {}, 
    create: { name: 'Undisclosed' } 
  });
  console.log('✅ Seeded genders');

  // Marital Status seeds (with unclear IDs: ms1, ms2, ms3, ms4)
  await prisma.maritalStatus.upsert({ 
    where: { maritalStatusId: 'ms1' }, 
    update: {}, 
    create: { maritalStatusId: 'ms1', name: 'Single' } 
  });
  await prisma.maritalStatus.upsert({ 
    where: { maritalStatusId: 'ms2' }, 
    update: {}, 
    create: { maritalStatusId: 'ms2', name: 'Married' } 
  });
  await prisma.maritalStatus.upsert({ 
    where: { maritalStatusId: 'ms3' }, 
    update: {}, 
    create: { maritalStatusId: 'ms3', name: 'Divorced' } 
  });
  await prisma.maritalStatus.upsert({ 
    where: { maritalStatusId: 'ms4' }, 
    update: {}, 
    create: { maritalStatusId: 'ms4', name: 'Undisclosed' } 
  });
  console.log('✅ Seeded marital statuses');

  // Indonesian Ethnicity seeds (with standardized UUIDs)
  const ethnicities: { id: string; name: string }[] = [
    { id: '11111111-1111-1111-1111-111111111111', name: 'Jawa' },
    { id: '22222222-2222-2222-2222-222222222222', name: 'Sunda' },
    { id: '33333333-3333-3333-3333-333333333333', name: 'Betawi' },
    { id: '44444444-4444-4444-4444-444444444444', name: 'Batak' },
    { id: '55555555-5555-5555-5555-555555555555', name: 'Minangkabau' },
    { id: '66666666-6666-6666-6666-666666666666', name: 'Bugis' },
    { id: '77777777-7777-7777-7777-777777777777', name: 'Madura' },
    { id: '88888888-8888-8888-8888-888888888888', name: 'Banjar' },
    { id: '99999999-9999-9999-9999-999999999999', name: 'Bali' },
    { id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', name: 'Aceh' },
    { id: 'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb', name: 'Dayak' },
    { id: 'cccccccc-cccc-cccc-cccc-cccccccccccc', name: 'Makassar' },
    { id: 'dddddddd-dddd-dddd-dddd-dddddddddddd', name: 'Lampung' },
    { id: 'eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee', name: 'Palembang' },
    { id: 'ffffffff-ffff-ffff-ffff-ffffffffffff', name: 'Gorontalo' },
    { id: '10101010-1010-1010-1010-101010101010', name: 'Toraja' },
    { id: '20202020-2020-2020-2020-202020202020', name: 'Minahasa' },
    { id: '30303030-3030-3030-3030-303030303030', name: 'Nias' },
    { id: '40404040-4040-4040-4040-404040404040', name: 'Sasak' },
    { id: '50505050-5050-5050-5050-505050505050', name: 'Lainnya' },
    { id: '60606060-6060-6060-6060-606060606060', name: 'Tidak Disebutkan' },
  ];
  for (const e of ethnicities) {
    await prisma.ethnicity.upsert({
      where: { ethnicityId: e.id },
      update: { name: e.name },
      create: { ethnicityId: e.id, name: e.name },
    });
  }
  console.log('✅ Seeded Indonesian ethnicities (21 entries with standardized UUIDs)');

  // --- Cities seed (only cityId and name, no code)
  const cities: { name: string }[] = [
    // Top-tier metros and large cities
    { code: 'ID-JKT', name: 'Jakarta' },
    { code: 'ID-SBY', name: 'Surabaya' },
    { code: 'ID-BDG', name: 'Bandung' },
    { code: 'ID-MDN', name: 'Medan' },
    { code: 'ID-SMG', name: 'Semarang' },
    { code: 'ID-MKS', name: 'Makassar' },
    { code: 'ID-PLB', name: 'Palembang' },
    { code: 'ID-PKU', name: 'Pekanbaru' },
    { code: 'ID-BLP', name: 'Balikpapan' },
    { code: 'ID-SMD', name: 'Samarinda' },
    { code: 'ID-BJM', name: 'Banjarmasin' },
    { code: 'ID-PTK', name: 'Pontianak' },
    { code: 'ID-YOG', name: 'Yogyakarta' },
    { code: 'ID-DPS', name: 'Denpasar' },
    { code: 'ID-BTM', name: 'Batam' },
    { code: 'ID-BGR', name: 'Bogor' },
    { code: 'ID-BKS', name: 'Bekasi' },
    { code: 'ID-TNG', name: 'Tangerang' },
    { code: 'ID-TGS', name: 'Tangerang Selatan' },
    { code: 'ID-DPK', name: 'Depok' },
    { code: 'ID-MLG', name: 'Malang' },
    { code: 'ID-PDG', name: 'Padang' },
    { code: 'ID-BDL', name: 'Bandar Lampung' },
    { code: 'ID-PLM', name: 'Palembang' },
    { code: 'ID-PSN', name: 'Pasuruan' },
    { code: 'ID-PBL', name: 'Probolinggo' },
    { code: 'ID-JBR', name: 'Jember' },
    { code: 'ID-BYW', name: 'Banyuwangi' },
    { code: 'ID-KDR', name: 'Kediri' },
    { code: 'ID-MJK', name: 'Mojokerto' },
    { code: 'ID-SDA', name: 'Sidoarjo' },
    { code: 'ID-GRS', name: 'Gresik' },
    { code: 'ID-SLO', name: 'Surakarta (Solo)' },
    { code: 'ID-MGL', name: 'Magelang' },
    { code: 'ID-SLT', name: 'Salatiga' },
    { code: 'ID-TGL', name: 'Tegal' },
    { code: 'ID-PKL', name: 'Pekalongan' },
    { code: 'ID-CRC', name: 'Cirebon' },
    { code: 'ID-TSM', name: 'Tasikmalaya' },
    { code: 'ID-SKB', name: 'Sukabumi' },
    { code: 'ID-GRT', name: 'Garut' },
    { code: 'ID-CJR', name: 'Cianjur' },
    { code: 'ID-KRW', name: 'Karawang' },
    { code: 'ID-PWK', name: 'Purwakarta' },
    { code: 'ID-SBG', name: 'Subang' },
    { code: 'ID-IDM', name: 'Indramayu' },
    { code: 'ID-SRG', name: 'Serang' },
    { code: 'ID-CLG', name: 'Cilegon' },
    { code: 'ID-BKS2', name: 'Kabupaten Bekasi' },
    // Sumatra and surrounding
    { code: 'ID-JMB', name: 'Jambi' },
    { code: 'ID-BKL', name: 'Bengkulu' },
    { code: 'ID-PKR', name: 'Pangkalpinang' },
    { code: 'ID-TJP', name: 'Tanjungpinang' },
    { code: 'ID-BNA', name: 'Banda Aceh' },
    { code: 'ID-LKS', name: 'Lhokseumawe' },
    { code: 'ID-LNG', name: 'Langsa' },
    { code: 'ID-BNJ', name: 'Binjai' },
    { code: 'ID-PMS', name: 'Pematangsiantar' },
    { code: 'ID-SBL', name: 'Sibolga' },
    { code: 'ID-PSP', name: 'Padang Sidempuan' },
    { code: 'ID-DMI', name: 'Dumai' },
    { code: 'ID-BKT', name: 'Bukittinggi' },
    { code: 'ID-PYK', name: 'Payakumbuh' },
    { code: 'ID-PRM', name: 'Pariaman' },
    { code: 'ID-SLK', name: 'Solok' },
    { code: 'ID-SWL', name: 'Sawahlunto' },
    { code: 'ID-LBK', name: 'Lubuklinggau' },
    { code: 'ID-PBM', name: 'Prabumulih' },
    { code: 'ID-PGA', name: 'Pagar Alam' },
    // Kalimantan, Sulawesi, Nusa Tenggara, Papua, Maluku
    { code: 'ID-TNJ', name: 'Tanjung' },
    { code: 'ID-TRK', name: 'Tarakan' },
    { code: 'ID-PTG', name: 'Palangkaraya' },
    { code: 'ID-PLP', name: 'Palopo' },
    { code: 'ID-PAR', name: 'Parepare' },
    { code: 'ID-KDRI', name: 'Kendari' },
    { code: 'ID-GTO', name: 'Gorontalo' },
    { code: 'ID-PLU', name: 'Palu' },
    { code: 'ID-MND', name: 'Manado' },
    { code: 'ID-ABN', name: 'Ambon' },
    { code: 'ID-JYP', name: 'Jayapura' },
    { code: 'ID-SRG2', name: 'Sorong' },
    { code: 'ID-TRT', name: 'Ternate' },
    { code: 'ID-TDR', name: 'Tidore' },
    { code: 'ID-MTR', name: 'Mataram' },
    { code: 'ID-KPG', name: 'Kupang' },
    { code: 'ID-BBU', name: 'Bau-Bau' },
    // Java other mid-size
    { code: 'ID-KLT', name: 'Klaten' },
    { code: 'ID-KDS', name: 'Kudus' },
    { code: 'ID-BOJ', name: 'Bojonegoro' },
    { code: 'ID-TBN', name: 'Tuban' },
    { code: 'ID-LMG', name: 'Lamongan' },
    { code: 'ID-BKL2', name: 'Bangkalan' },
    { code: 'ID-PMK', name: 'Pamekasan' },
    { code: 'ID-SMP', name: 'Sumenep' },
    { code: 'ID-SIT', name: 'Situbondo' },
    { code: 'ID-LMJ', name: 'Lumajang' },
    { code: 'ID-TLG', name: 'Tulungagung' },
    { code: 'ID-BLT', name: 'Blitar' },
    { code: 'ID-MDN2', name: 'Madiun' },
    { code: 'ID-NGW', name: 'Ngawi' },
    // Special
    { code: 'OTHER', name: 'Other (Specify)' },
  ];

  for (const city of cities) {
    await prisma.city.upsert({
      where: { code: city.code },
      update: {},
      create: {
        code: city.code,
        name: city.name,
      },
    });
  }
  console.log('✅ Seeded Indonesian cities');

  // Example: attach birth places to seeded persons
  await prisma.user.update({
    where: { email: 'fardil.khalidi@gmail.com' },
    data: { person: { update: { birthPlaceCode: 'ID-JKT' } } },
  }).catch(() => undefined);
  await prisma.user.update({
    where: { email: 'attarasmawan@gmail.com' },
    data: { person: { update: { birthPlaceCode: 'ID-SBY' } } },
  }).catch(() => undefined);

  // access seeds (role-based menus stored in DB)
  const dashboard = { key: 'dashboard', title: 'Dashboard', url: '/dashboard', icon: 'fa:fa-gauge' };
  const aiRec = { key: 'ai-recommendation', title: 'AI Recommendation', url: '/ai-recommendation', icon: 'fa:fa-wand-magic-sparkles' };
  const receiver = { key: 'receiver', title: 'Receiver', url: '/receiver', icon: 'fa:fa-address-book' };
  const settings = { key: 'settings', title: 'Settings', url: '/settings', icon: 'fa:fa-gear' };
  const groups = { key: 'groups', title: 'Groups', url: '/groups', icon: 'fa:fa-users' };
  const occasion: Prisma.InputJsonObject = {
    key: 'occasion',
    title: 'Occasions',
    url: '/occasion',
    icon: 'fa:fa-calendar-days',
    children: [
      { key: 'occasion-list', title: 'List', url: '/occasion' },
      { key: 'occasion-create', title: 'Create', url: '/occasion/create' },
    ],
  };
  const gift: Prisma.InputJsonObject = {
    key: 'gift',
    title: 'Gift',
    url: '/gift',
    icon: 'fa:fa-gift',
    children: [
      { key: 'gift-hampers', title: 'Hampers', url: '/gift/hampers', icon: 'fa:fa-box' },
      { key: 'gift-fruit', title: 'Fruit', url: '/gift/fruit', icon: 'fa:fa-apple-whole' },
      { key: 'gift-surprise', title: 'Surprise', url: '/gift/surprise', icon: 'fa:fa-wand-magic-sparkles' },
      { key: 'gift-utensils', title: 'Utensils', url: '/gift/utensils', icon: 'fa:fa-utensils' },
    ],
  };
  const affiliate: Prisma.InputJsonObject = {
    key: 'affiliate',
    title: 'Affiliate',
    url: '/affiliate-setting',
    icon: 'fa:fa-link',
    children: [
      { key: 'affiliate-settings', title: 'Settings', url: '/affiliate-setting', icon: 'fa:fa-gear' },
      { key: 'affiliate-master', title: 'Master', url: '/affiliate-setting/master', icon: 'fa:fa-database' },
    ],
  };

  const individualMenu: Prisma.InputJsonValue = [
    dashboard,
    aiRec,
    receiver,
    settings,
    groups,
    occasion,
  ];
  const organizationMenu: Prisma.InputJsonValue = [
    dashboard,
    aiRec,
    receiver,
    settings,
    groups,
    occasion,
    gift,
  ];
  const adminMenu: Prisma.InputJsonValue = [
    settings,
    affiliate,
  ];

  await prisma.access.upsert({
    where: { id: 'ac02' },
    update: { name: 'individual', json: individualMenu },
    create: { id: 'ac02', name: 'individual', json: individualMenu },
  });
  await prisma.access.upsert({
    where: { id: 'ac01' },
    update: { name: 'organization', json: organizationMenu },
    create: { id: 'ac01', name: 'organization', json: organizationMenu },
  });
  await prisma.access.upsert({
    where: { id: 'ac03' },
    update: { name: 'administrator', json: adminMenu },
    create: { id: 'ac03', name: 'administrator', json: adminMenu },
  });

  const defaultHash = await argon2.hash('default');

  // helper to create a user with optional display name
  async function seedUser(usernameEmail: string, displayName?: string) {
    const existing = await prisma.user.findUnique({ where: { email: usernameEmail } });
    if (existing) return existing;

    // Always create a person first with minimal defaults
    const person = await prisma.person.create({
      data: { personName: displayName ?? usernameEmail },
    });

    return prisma.user.create({
      data: {
        email: usernameEmail,
        passwordHash: defaultHash,
        personId: person.personId,
        statusCode: 1,
        isAdmin: false,
      },
    });
  }

  await seedUser('fardil.khalidi@gmail.com', 'Fardil Khalidi');
  await seedUser('attarasmawan@gmail.com', 'Attar Asmawan');

  // link persons to access
  async function linkPersonAccess(userEmail: string, accessId: string) {
    const u = await prisma.user.findUnique({
      where: { email: userEmail },
      include: { person: true },
    });
    if (!u) return;
    let personId = u.person?.personId;
    if (!personId) {
      const p = await prisma.person.create({ data: { personName: userEmail } });
      personId = p.personId;
      await prisma.user.update({ where: { id: u.id }, data: { personId } });
    }
    const already = await prisma.personAccess.findFirst({
      where: { personId, accessId },
    });
    if (!already) {
      await prisma.personAccess.create({ data: { personId, accessId } });
    }
  }

  await linkPersonAccess('fardil.khalidi@gmail.com', 'ac01'); // organization
  await linkPersonAccess('attarasmawan@gmail.com', 'ac02'); // individual

  // seed administrator user and link to ac03
  async function seedAdminUser(email: string, displayName?: string) {
    const existing = await prisma.user.findUnique({ where: { email } });
    if (existing) return existing;

    const person = await prisma.person.create({ data: { personName: displayName ?? email } });

    const passwordHash = await argon2.hash('default');
    const user = await prisma.user.create({
      data: {
        email,
        passwordHash,
        personId: person.personId,
        statusCode: 1,
        isAdmin: true,
      },
    });

    // link to administrator access (ac03)
    const already = await prisma.personAccess.findFirst({ where: { personId: person.personId, accessId: 'ac03' } });
    if (!already) {
      await prisma.personAccess.create({ data: { personId: person.personId, accessId: 'ac03' } });
    }
    return user;
  }

  await seedAdminUser('administrator@sevenrose.com', 'Administrator');

  const jobs: { code: string; name: string }[] = [
    { code: 'teacher', name: 'Teacher' },
    { code: 'doctor', name: 'Doctor' },
    { code: 'nurse', name: 'Nurse' },
    { code: 'engineer', name: 'Engineer' },
    { code: 'developer', name: 'Software Developer' },
    { code: 'designer', name: 'Designer' },
    { code: 'architect', name: 'Architect' },
    { code: 'accountant', name: 'Accountant' },
    { code: 'sales', name: 'Sales Representative' },
    { code: 'marketing', name: 'Marketing Specialist' },
    { code: 'consultant', name: 'Consultant' },
    { code: 'writer', name: 'Writer' },
    { code: 'photographer', name: 'Photographer' },
    { code: 'chef', name: 'Chef' },
    { code: 'driver', name: 'Driver' },
    { code: 'security', name: 'Security Guard' },
    { code: 'mechanic', name: 'Mechanic' },
    { code: 'student', name: 'Student' },
    { code: 'researcher', name: 'Researcher' },
    { code: 'entrepreneur', name: 'Entrepreneur' },
  ];

  for (const job of jobs) {
    await prisma.job.upsert({
      where: { code: job.code },
      update: {},
      create: job,
    });
  }
  console.log('✅ Seeded 20 common job titles');
}
main()
  .then(async () => {
    await prisma.$disconnect();
  })
  .catch(async (e) => {
    console.error(e);
    await prisma.$disconnect();
    process.exit(1);
  });