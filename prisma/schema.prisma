generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User table mapped to legacy/explicit column names
model User {
  id            String    @id @default(uuid()) @map("user_id") @db.Uuid
  email         String    @unique @map("user_nm")
  passwordHash  String    @map("pass_hash")
  isAdmin       Boolean   @default(false) @map("is_admin")
  personId      String?   @unique @map("person_id") @db.Uuid
  statusCode    Int       @default(1) @map("status_code") // 0=inactive,1=active
  createdAt     DateTime  @default(now()) @map("created_dttm")
  createdUserId String    @default("administrator") @map("created_user_id")
  updatedAt     DateTime? @map("updated_dttm")
  updatedUserId String?   @map("updated_user_id")

  // relations
  person        Person?        @relation(fields: [personId], references: [personId])
  refreshTokens RefreshToken[]
  picks         Pick[]

  @@map("user")
}

model Person {
  personId              String              @id @default(uuid()) @map("person_id") @db.Uuid
  address               String?             @map("address")
  personName            String?             @map("person_name")
  firstName             String?             @map("first_name")
  lastName              String?             @map("last_name")
  salutation            String?             @map("salutation")
  genderId              String?             @map("gender_id") @db.Uuid
  birthDttm             DateTime?           @map("birth_dttm") @db.Date
  cityId                String?             @map("city_id") @db.Uuid
  jobId                 String?             @map("job_id") @db.Uuid
  ethnicityId           String?             @map("ethnicity_id") @db.Uuid
  maritalStatusId       String?             @map("marital_status_id")
  isFree                Boolean             @default(false) @map("is_free")
  organizationLevelId   String?             @map("organization_level_id") @db.Uuid
  createdAt             DateTime            @default(now()) @map("created_dttm")
  createdUserId         String              @default("administrator") @map("created_user_id")
  updatedAt             DateTime?           @map("updated_dttm")
  updatedUserId         String?             @map("updated_user_id")

  // relations
  gender                Gender?             @relation(fields: [genderId], references: [genderId])
  city                  City?               @relation(fields: [cityId], references: [cityId])
  job                   Job?                @relation(fields: [jobId], references: [jobId])
  ethnicity             Ethnicity?          @relation(fields: [ethnicityId], references: [ethnicityId])
  maritalStatus         MaritalStatus?      @relation(fields: [maritalStatusId], references: [maritalStatusId])
  organizationLevel     OrganizationLevel?  @relation(fields: [organizationLevelId], references: [organizationLevelId])

  users                   User[]
  personAccesses          PersonAccess[]
  upcomingEvents          UpcomingEvent[]
  trxRelationsAsGifter    TrxRelation[]          @relation("TrxRelationGifter")
  trxRelationsAsReceiver  TrxRelation[]          @relation("TrxRelationReceiver")
  organizationsCreated    Organization[]
  organizationMemberships OrganizationMember[]

  @@map("person")
}

model Gender {
  genderId String   @id @default(uuid()) @map("gender_id") @db.Uuid
  name     String

  persons  Person[]

  @@map("gender")
}

model City {
  cityId  String   @id @default(uuid()) @map("city_id") @db.Uuid
  name    String

  persons Person[]

  @@map("city")
}

model Ethnicity {
  ethnicityId String   @id @default(uuid()) @map("ethnicity_id") @db.Uuid
  name        String

  persons     Person[]

  @@map("ethnicity")
}

model MaritalStatus {
  maritalStatusId String   @id @map("marital_status_id")
  name            String

  persons         Person[]

  @@map("marital_status")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id") @db.Uuid
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String    @map("token_hash") // hash of the refresh token (never store raw token)
  createdAt DateTime  @default(now()) @map("created_dttm")
  expiresAt DateTime  @map("expires_dttm")
  revokedAt DateTime? @map("revoked_dttm")

  @@index([userId])
  @@map("refresh_token")
}

// Access control table (roles/profiles)
model Access {
  id          String    @id @map("access_id")
  name        String    @map("access_name")
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // relations
  personAccesses PersonAccess[]
  accessMenus    AccessMenu[]

  @@map("access")
}

// Menu items table
model Menu {
  id        String    @id @default(uuid()) @db.Uuid
  key       String    @unique
  parentId  String?   @map("parent_id") @db.Uuid
  url       String
  icon      String?
  title     String
  order     Int       @default(0)
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // relations
  parent       Menu?        @relation("MenuHierarchy", fields: [parentId], references: [id])
  children     Menu[]       @relation("MenuHierarchy")
  accessMenus  AccessMenu[]

  @@index([parentId])
  @@index([order])
  @@map("menus")
}

// Pivot table: which menus each access can see
model AccessMenu {
  id        String    @id @default(uuid()) @map("access_menu_id") @db.Uuid
  accessId  String    @map("access_id")
  menuId    String    @map("menu_id") @db.Uuid
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")

  // relations
  access Access @relation(fields: [accessId], references: [id], onDelete: Cascade)
  menu   Menu   @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([accessId, menuId])
  @@index([accessId])
  @@index([menuId])
  @@map("access_menus")
}

// Pivot table person_access (many-to-many Person <-> Access)
model PersonAccess {
  id        String    @id @default(uuid()) @map("person_access_id") @db.Uuid
  personId  String    @map("person_id") @db.Uuid
  accessId  String    @map("access_id")
  isActive  Boolean   @default(true) @map("is_active")
  isDefault Boolean   @default(false) @map("is_default")
  createdAt DateTime  @default(now()) @map("created_at")

  // relations
  person Person @relation(fields: [personId], references: [personId], onDelete: Cascade)
  access Access @relation(fields: [accessId], references: [id], onDelete: Cascade)

  @@unique([personId, accessId])
  @@index([personId])
  @@index([accessId])
  @@map("person_access")
}

model Job {
  jobId   String   @id @default(uuid()) @map("job_id") @db.Uuid
  name    String

  persons Person[]

  @@map("job")
}

// JobOther table removed - use Job with name='Other' instead

model OrganizationLevel {
  organizationLevelId   String   @id @default(uuid()) @map("organization_level_id") @db.Uuid
  organizationLevelName String   @map("organization_level_name")

  persons               Person[]

  @@map("organization_level")
}

model MasterRelation {
  relationId   String  @id @default(uuid()) @map("relation_id") @db.Uuid
  relationName String  @map("relation_name")
  description  String?

  trxRelations   TrxRelation[]
  upcomingEvents UpcomingEvent[]

  @@map("master_relation")
}

model TrxRelation {
  trxRelationId  String  @id @default(uuid()) @map("trx_relation_id") @db.Uuid
  relationId     String  @map("relation_id") @db.Uuid
  personGifter   String? @map("person_gifter") @db.Uuid
  personReceiver String? @map("person_receiver") @db.Uuid

  relation       MasterRelation @relation(fields: [relationId], references: [relationId], onDelete: Cascade)
  gifter         Person?        @relation("TrxRelationGifter", fields: [personGifter], references: [personId])
  receiver       Person?        @relation("TrxRelationReceiver", fields: [personReceiver], references: [personId])

  @@index([relationId])
  @@index([personGifter])
  @@index([personReceiver])
  @@map("trx_relation")
}

model Pick {
  pickId      String   @id @default(uuid()) @map("pick_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  title       String
  imageUrl    String?  @map("image_url")
  description String?
  cost        String?
  url         String
  savedAt     DateTime @default(now()) @map("saved_at")
  createdAt   DateTime @default(now()) @map("created_dttm")
  updatedAt   DateTime @updatedAt @map("updated_dttm")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("pick")
}

model UpcomingEvent {
  upcomingEventId    String         @id @default(uuid()) @map("upcoming_event_id") @db.Uuid
  personId           String         @map("person_id") @db.Uuid
  upcomingEventTitle String         @map("upcoming_event_title")
  relationId         String         @map("relation_id") @db.Uuid
  eventDate          DateTime       @map("event_date") @db.Date

  person             Person         @relation(fields: [personId], references: [personId], onDelete: Cascade)
  relation           MasterRelation @relation(fields: [relationId], references: [relationId])

  @@index([personId])
  @@index([relationId])
  @@map("upcoming_event")
}

// Organization model
model Organization {
  id                 String   @id @default(uuid()) @db.Uuid
  name               String
  code               String   @unique
  description        String?
  logoUrl            String?  @map("logo_url")
  contactEmail       String?  @map("contact_email")
  contactPhone       String?  @map("contact_phone")
  isActive           Boolean  @default(true) @map("is_active")
  createdByPersonId  String   @map("created_by_person_id") @db.Uuid
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  createdBy          Person                @relation(fields: [createdByPersonId], references: [personId])
  members            OrganizationMember[]

  @@index([code])
  @@index([createdByPersonId])
  @@map("organizations")
}

// Organization members (person-organization relationship)
model OrganizationMember {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  personId       String   @map("person_id") @db.Uuid
  role           String   // OWNER, ORGANIZATION_ADMIN, MEMBER
  status         String   @default("ACTIVE") // ACTIVE, INVITED, REMOVED
  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  person         Person       @relation(fields: [personId], references: [personId], onDelete: Cascade)

  @@unique([organizationId, personId])
  @@index([organizationId])
  @@index([personId])
  @@index([status])
  @@map("organization_members")
}
